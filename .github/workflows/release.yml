name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    name: Release pushed tag
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Ensures full history is available

      - name: Install PowerShell Core (pwsh)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget apt-transport-https software-properties-common
          wget -q "https://packages.microsoft.com/config/ubuntu/22.04/prod.list" -O /etc/apt/sources.list.d/microsoft-prod.list
          sudo apt-get install -y powershell

      - name: Install ps2exe in PowerShell
        run: pwsh -Command 'Install-Module -Name ps2exe -Force -Scope CurrentUser'

      - name: Run build.ps1 to create distribution folder
        run: pwsh ./build.ps1

      - name: Check distribution folder contents
        run: |
          if [ -d distribution ]; then
            echo "Contents of distribution folder:"
            ls distribution
          else
            echo "Distribution folder does not exist!"
          fi

      - name: Create ZIP of distribution Folder
        run: |
          zip -r distribution.zip distribution/*

      - name: Generate Release Notes
        id: release_notes
        run: |
          prev_tag=$(git describe --tags --abbrev=0 HEAD~ || echo "v0.0.0")
          changes=$(git log "$prev_tag"..HEAD --pretty=format:"%s by @%an in %h" --reverse)
          breaking=""
          features=""
          fixes=""
          others=""
          while IFS= read -r line; do
            if echo "$line" | grep -iq "BREAKING CHANGE"; then
              breaking="$breaking"$'\n'"⚠️ $line"
            elif echo "$line" | grep -iq "feat:"; then
              features="$features"$'\n'"- Feature: $line"
            elif echo "$line" | grep -iq "fix:"; then
              fixes="$fixes"$'\n'"- Fix: $line"
            else
              others="$others"$'\n'"- Other: $line"
            fi
          done <<< "$changes"
          notes="## What's Changed"
          if [ -n "$fixes" ]; then notes="$notes"$'\n'"$fixes"; fi
          if [ -n "$features" ]; then notes="$notes"$'\n'"$features"; fi
          if [ -n "$breaking" ]; then notes="$notes"$'\n'"$breaking"; fi
          if [ -n "$others" ]; then notes="$notes"$'\n'"$others"; fi
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$notes" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
        run: |
          gh release create "$tag" \
              --repo="$GITHUB_REPOSITORY" \
              --title="${tag#v}" \
              --notes "$RELEASE_NOTES" \
              distribution.zip
